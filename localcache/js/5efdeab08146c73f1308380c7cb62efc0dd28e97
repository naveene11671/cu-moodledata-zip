/**
 * JavaScript for the course selectors.
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @package courseselector
 */
M.local_course_selector=M.local_course_selector||{};M.local_course_selector.course_selectors=[];M.local_course_selector.get_course_selector=function(name){return this.course_selectors[name]||null};M.local_course_selector.init_course_selector=function(Y,name,hash,extrafields,lastsearch){var course_selector={name:name,extrafields:extrafields,querydelay:0.5,searchfield:Y.one('#'+name+'_searchtext'),clearbutton:null,listbox:Y.one('#'+name),timeoutid:null,lastsearch:lastsearch,selectionempty:!0,init:function(){var searchbutton=Y.one('#'+this.name+'_searchbutton');this.searchfield.insert(Y.Node.create('<label for="'+this.name+'_searchtext">'+searchbutton.get('value')+'</label>'),this.searchfield);searchbutton.remove();this.searchfield.on('keyup',this.handle_keyup,this);this.listbox.on('keyup',this.handle_selection_change,this);this.listbox.on('click',this.handle_selection_change,this);this.listbox.on('change',this.handle_selection_change,this);Y.one('#courseselector_searchanywhereid').on('click',this.handle_searchanywhere_change,this);this.selectionempty=this.is_selection_empty();var clearbtn=Y.one('#'+this.name+'_clearbutton');this.clearbutton=Y.Node.create('<input type="button" value="'+clearbtn.get('value')+'" />');clearbtn.replace(Y.Node.getDOMNode(this.clearbutton));this.clearbutton.set('id',+this.name+"_clearbutton");this.clearbutton.on('click',this.handle_clear,this);this.send_query(!1)},handle_keyup:function(e){this.cancel_timeout();this.timeoutid=setTimeout(function(obj){obj.send_query(!1)},this.querydelay*1000,this);this.clearbutton.set('disabled',(this.get_search_text()==''));if(e.keyCode==13){e.halt()}},handle_selection_change:function(){var isselectionempty=this.is_selection_empty();if(isselectionempty!==this.selectionempty){this.fire('course_selector:selectionchanged',isselectionempty)}
this.selectionempty=isselectionempty},handle_searchanywhere_change:function(){if(this.lastsearch!=''&&this.get_search_text()!=''){this.send_query(!0)}},handle_clear:function(){this.searchfield.set('value','');this.clearbutton.set('disabled',!0);this.send_query(!1)},send_query:function(forceresearch){this.cancel_timeout();var value=this.get_search_text();this.searchfield.set('class','');if(this.lastsearch==value&&!forceresearch){return}
Y.io(M.cfg.wwwroot+'/local/course_selector/search.php',{method:'POST',data:'selectorid='+hash+'&sesskey='+M.cfg.sesskey+'&search='+value+'&courseselector_searchanywhere='+this.get_option('searchanywhere'),on:{success:this.handle_response,failure:this.handle_failure},context:this});this.lastsearch=value;this.listbox.setStyle('background','url('+M.util.image_url('i/loading','moodle')+') no-repeat center center')},handle_response:function(requestid,response){try{this.listbox.setStyle('background','');var data=Y.JSON.parse(response.responseText);this.output_options(data)}catch(e){this.handle_failure()}},handle_failure:function(){this.listbox.setStyle('background','');this.searchfield.addClass('error');if(M.cfg.developerdebug){this.searchfield.insert(Y.Node.create('<a href="'+M.cfg.wwwroot+'/local/course_selector/search.php?selectorid='+hash+'&sesskey='+M.cfg.sesskey+'&search='+this.get_search_text()+'&debug=1">Ajax call failed. Click here to try the search call directly.</a>'))}},output_options:function(data){var selectedcourses={};this.listbox.all('optgroup').each(function(optgroup){optgroup.all('option').each(function(option){if(option.get('selected')){selectedcourses[option.get('value')]={id:option.get('value'),name:option.get('innerText')||option.get('textContent'),disabled:option.get('disabled')}}
option.remove()},this);optgroup.remove()},this);var count=0;for(var groupname in data.results){this.output_group(groupname,data.results[groupname],selectedcourses,!0);count++}
if(!count){var searchstr=(this.lastsearch!='')?this.insert_search_into_str(M.str.local_course_selector.nomatchingcourses,this.lastsearch):M.str.moodle.none;this.output_group(searchstr,{},selectedcourses,!0)}
if(this.get_option('preserveselected')&&selectedcourses){this.output_group(this.insert_search_into_str(M.str.local_course_selector.previouslyselectedcourses,this.lastsearch),selectedcourses,!0,!1)}
this.handle_selection_change()},output_group:function(groupname,courses,selectedcourses,processsingle){var optgroup=Y.Node.create('<optgroup></optgroup>');var count=0;for(var courseid in courses){var course=courses[courseid];var option=Y.Node.create('<option value="'+courseid+'">'+course.name+'</option>');if(course.disabled){option.set('disabled',!0)}else if(selectedcourses===!0||selectedcourses[courseid]){option.set('selected',!0)}else{option.set('selected',!1)}
optgroup.append(option);count++}
if(count>0){optgroup.set('label',groupname+' ('+count+')');if(processsingle&&count===1&&this.get_option('autoselectunique')&&option.get('disabled')){option.set('selected',!0)}}else{optgroup.append(Y.Node.create('<option disabled="disabled">\u00A0</option>'))}
this.listbox.append(optgroup)},insert_search_into_str:function(str,search){return str.replace("%%SEARCHTERM%%",search)},get_search_text:function(){return this.searchfield.get('value').toString().replace(/^ +| +$/,'')},is_selection_empty:function(){var selection=!1;this.listbox.all('option').each(function(){if(this.get('selected')){selection=!0}});return!(selection)},cancel_timeout:function(){if(this.timeoutid){clearTimeout(this.timeoutid);this.timeoutid=null}},get_option:function(name){var checkbox=Y.one('#courseselector_'+name+'id');if(checkbox){return(checkbox.get('checked'))}else{return!1}}};Y.augment(course_selector,Y.EventTarget,null,null,{});course_selector.init();this.course_selectors[name]=course_selector;return course_selector};M.local_course_selector.init_course_selector_options_tracker=function(Y){var course_selector_options_tracker={init:function(){var settings=['courseselector_preserveselected','courseselector_autoselectunique','courseselector_searchanywhere'];for(var s in settings){var setting=settings[s];Y.one('#'+setting+'id').on('click',this.set_user_preference,this,setting)}},set_user_preference:function(e,name){M.util.set_user_preference(name,Y.one('#'+name+'id').get('checked'))}};course_selector_options_tracker.init();return course_selector_options_tracker}