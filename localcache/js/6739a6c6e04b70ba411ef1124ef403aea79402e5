
/**
 * @file       Javascript functions for Multitopic course format.
 * @copyright  2019 James Calder and Otago Polytechnic
 * @author     James Calder
 * @author     Jeremy FitzPatrick
 * @author     Kuslan Kabalin and others.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
M.course=M.course||{};M.course.format=M.course.format||{};M.course.format.get_config=function(){return{container_node:'ul',container_class:'sections',section_node:'li',section_class:'section'}};M.course.format.swap_sections=function(Y,node1,node2){var CSS={COURSECONTENT:'course-content',SECTIONADDMENUS:'section_add_menus'};var sectionlist=Y.Node.all('.'+CSS.COURSECONTENT+' '+M.course.format.get_section_selector(Y));if(sectionlist.item(node1).one('.'+CSS.SECTIONADDMENUS)){sectionlist.item(node1).one('.'+CSS.SECTIONADDMENUS).swap(sectionlist.item(node2).one('.'+CSS.SECTIONADDMENUS))}};M.course.format.process_sections=function(Y,sectionlist,response,sectionfrom,sectionto){var CSS={SECTIONNAME:'sectionname'},SELECTORS={SECTIONLEFTSIDE:'.left .section-handle .icon'};if(response.action=='move'){if(sectionfrom>sectionto){var temp=sectionto;sectionto=sectionfrom;sectionfrom=temp}
var ele,str,stridx,newstr;for(var i=sectionfrom;i<=sectionto;i++){var content=Y.Node.create('<span>'+response.sectiontitles[i]+'</span>');sectionlist.item(i).all('.'+CSS.SECTIONNAME).setHTML(content);ele=sectionlist.item(i).one(SELECTORS.SECTIONLEFTSIDE).ancestor('.section-handle');str=ele.getAttribute('title');stridx=str.lastIndexOf(' ');newstr=str.substr(0,stridx+1)+i;ele.setAttribute('title',newstr);sectionlist.item(i).setAttribute('aria-label',content.get('innerText').trim());if(sectionlist.item(i).hasClass("section-topic-collapsible")){M.course.format.fmtCollapseIconYui(sectionlist.item(i))}
sectionlist.item(i).removeClass('current')}
if(response.current!==-1){sectionlist.item(response.current).addClass('current')}}};M.course.format.fmtCollapseIcon=function(sectionDom){var show=!sectionDom.classList.contains("section-collapsed");var iconDom=sectionDom.querySelector("h3.sectionname i.icon");if(!iconDom){return}
iconDom.setAttribute("class",show?"icon fa fa-caret-down fa-fw":"icon fa fa-caret-right fa-fw")};M.course.format.fmtCollapseIconYui=function(sectionYui){var show=!sectionYui.hasClass("section-collapsed");var iconYui=sectionYui.one("h3.sectionname i.icon");if(!iconYui){return}
iconYui.setAttribute("class",show?"icon fa fa-caret-down fa-fw":"icon fa fa-caret-right fa-fw")};M.course.format.fmtCollapseSet=function(sectionDom,show){if(show===undefined){show=sectionDom.classList.contains("section-collapsed")}
if(show){sectionDom.classList.remove("section-collapsed");sectionDom.classList.add("section-expanded")}else{sectionDom.classList.remove("section-expanded");sectionDom.classList.add("section-collapsed")}
M.course.format.fmtCollapseIcon(sectionDom)};M.course.format.fmtCollapseOnClick=function(event){var eventTarget=event.target;if(eventTarget&&eventTarget.tagName&&eventTarget.tagName!="A"){eventTarget=eventTarget.parentElement}
var sectionId;if(eventTarget.hash){sectionId=eventTarget.hash.substr(1)}else if(eventTarget.search&&(eventTarget.search.indexOf("&sectionid=")>=0)){var sectionIdStart=eventTarget.search.indexOf("&sectionid=")+11;var sectionIdEnd=eventTarget.search.indexOf("&",sectionIdStart);if(sectionIdEnd<0){sectionIdEnd=eventTarget.search.length}
sectionId=(sectionIdEnd>sectionIdStart)?"sectionid-"+eventTarget.search.substring(sectionIdStart,sectionIdEnd):""}else{return}
var selSectionDom=sectionId?document.querySelector("body.format-multitopic .course-content ul.sections li.section."+sectionId):null;if(!selSectionDom||selSectionDom.querySelector(".content h3 a")!=eventTarget){return}
if(selSectionDom.classList.contains("section-topic-collapsible")&&!selSectionDom.classList.contains("section-userhidden")){M.course.format.fmtCollapseSet(selSectionDom)}
if(window.location.hash&&window.location.hash!="#"){history.pushState(null,document.title,window.location.href.substr(0,window.location.href.length-window.location.hash.length))}
M.course.format.fmtCollapseAllControlsUpdate();event.preventDefault()};M.course.format.fmtCollapseOnHashChange=function(event){var anchor=window.location.hash.substr(1);var selSectionDom=anchor?document.querySelector("body.format-multitopic .course-content ul.sections li.section.section-topic."+anchor):null;if(event&&!selSectionDom){return}
var sectionsDom=document.querySelectorAll("body.format-multitopic .course-content ul.sections li.section.section-topic-collapsible");for(var sectionCount=0;sectionCount<sectionsDom.length;sectionCount++){var sectionDom=sectionsDom[sectionCount];M.course.format.fmtCollapseSet(sectionDom,sectionDom==selSectionDom&&!sectionDom.classList.contains("section-userhidden"))}
M.course.format.fmtCollapseAllControlsUpdate();if(selSectionDom){selSectionDom.scrollIntoView()}};M.course.format.fmtCollapseAllOnClick=function(event){var eventTarget=event.target;var expand=!eventTarget.classList.contains('collapse-all');var sectionsDom=document.querySelectorAll("body.format-multitopic .course-content ul.sections li.section.section-topic-collapsible");for(var sectionCount=0;sectionCount<sectionsDom.length;sectionCount++){var sectionDom=sectionsDom[sectionCount];M.course.format.fmtCollapseSet(sectionDom,expand&&!sectionDom.classList.contains("section-userhidden"))}
M.course.format.fmtCollapseAllControlsUpdate();event.preventDefault()};M.course.format.fmtCollapseAllControlsUpdate=function(){var collapsedNum=0;var sectionsDom=document.querySelectorAll("body.format-multitopic .course-content ul.sections li.section.section-topic-collapsible");for(var sectionCount=0;sectionCount<sectionsDom.length;sectionCount++){var sectionDom=sectionsDom[sectionCount];if(sectionDom.offsetWidth>0&&sectionDom.offsetHeight>0&&!sectionDom.classList.contains("section-userhidden")){if(sectionDom.classList.contains('section-collapsed')){collapsedNum++}}}
document.querySelector("body.format-multitopic .collapsible-actions .expand-all").setAttribute("style",(collapsedNum)?"":"display: none;");document.querySelector("body.format-multitopic .collapsible-actions .collapse-all").setAttribute("style",(!collapsedNum)?"":"display: none;")};M.course.format.fmtChangeName=function(e){if(e.target.dataset.itemtype==='sectionname'){var sectionid=e.target.dataset.itemid;var newname=e.target.dataset.value;var tabs=document.querySelectorAll(".nav-tabs .tab_content[data-itemid='"+sectionid+"']");for(var ti=0;ti<tabs.length;ti++){tabs[ti].innerHTML=newname}}};M.course.format.fmtWarnMaxsections=function(e){var cantaddlink=e.target.matches('.cantadd');if(cantaddlink===!1&&e.target.firstElementChild!==null){cantaddlink=e.target.firstElementChild.matches('.cantadd')}
if(cantaddlink){e.preventDefault();require(['core/notification'],function(notification){notification.addNotification({message:M.course.format.fmtMaxsections,type:'warning'})});window.scroll({top:0,left:0,behavior:'smooth'})}
return!0};M.course.format.fmtInit=function(Y,max){M.course.format.fmtMaxsections=max;M.course.format.fmtCollapseOnHashChange();document.querySelector("body.format-multitopic .course-content ul.sections").addEventListener("click",M.course.format.fmtCollapseOnClick);window.addEventListener("hashchange",M.course.format.fmtCollapseOnHashChange);document.querySelector("body.format-multitopic .collapsible-actions").addEventListener("click",M.course.format.fmtCollapseAllOnClick);require(['jquery'],function($){var tabcontent=document.querySelector(".course-content ul.sections");$(tabcontent).on('updated',M.course.format.fmtChangeName)});document.querySelector(".course-content").addEventListener('click',M.course.format.fmtWarnMaxsections)}